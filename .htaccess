# Configuración del Sistema de Tutorías UNSAAC
Options -Indexes -MultiViews
DirectoryIndex frontend/index.html

<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /Sistema-de-tutorias/

  # ============================================
  # BACKEND API - Rutas sin extensión .php (MÁXIMA PRIORIDAD)
  # ============================================
  
  # Permitir acceso directo a archivos estáticos del backend ANTES de bloquear
  RewriteRule ^backend/(storage|vendor|credentials)/(.*)$ backend/$1/$2 [L,NC]
  
  # Todas las rutas /backend/api/* van al enrutador routes.php
  RewriteRule ^backend/api/(.*)$ backend/routes.php [L,QSA]
  
  # Todas las rutas /api/* también van al enrutador (compatibilidad sin prefijo backend)
  RewriteRule ^api/(.*)$ backend/routes.php [L,QSA]
  
  # Bloquear acceso directo a archivos PHP del backend (excepto routes.php y test-*.php)
  RewriteCond %{REQUEST_URI} backend/.*\.php$
  RewriteCond %{REQUEST_URI} !backend/routes\.php$
  RewriteCond %{REQUEST_URI} !backend/test-.*\.php$
  RewriteRule .* - [F,L]

  # ============================================
  # FRONTEND - Rutas limpias sin .html
  # ============================================
  
  # Raíz del sitio -> index.html
  RewriteRule ^$ frontend/index.html [L]

  # Redirigir URLs con .html a versiones sin extensión (301 permanente)
  RewriteCond %{THE_REQUEST} \s/+Sistema-de-tutorias/(login|verify|panel|index)\.html[\s?] [NC]
  RewriteRule ^(.*)\.html$ /$1 [R=301,L]

  # ============================================
  # PÁGINAS PRINCIPALES
  # ============================================
  
  # Páginas de autenticación y panel
  RewriteRule ^login/?$ frontend/login.html [L,NC]
  RewriteRule ^verify/?$ frontend/verify.html [L,NC]
  RewriteRule ^panel/?$ frontend/panel.html [L,NC,QSA]
  RewriteRule ^dashboard/?$ frontend/panel.html [L,NC,QSA]
  RewriteRule ^index/?$ frontend/index.html [L,NC]
  
  # ============================================
  # MÓDULOS DEL ADMINISTRADOR
  # ============================================
  
  RewriteRule ^semestre/?$ frontend/panel.html [L,NC]
  RewriteRule ^gestion-usuarios/?$ frontend/panel.html [L,NC]
  RewriteRule ^asignaciones/?$ frontend/panel.html [L,NC]
  RewriteRule ^reportes/?$ frontend/panel.html [L,NC]
  RewriteRule ^historial/?$ frontend/panel.html [L,NC]
  RewriteRule ^auditoria/?$ frontend/panel.html [L,NC]
  
  # ============================================
  # MÓDULOS DEL TUTOR
  # ============================================
  
  RewriteRule ^tutor/?$ frontend/panel.html [L,NC]
  RewriteRule ^asignacionTutor/?$ frontend/panel.html [L,NC]
  RewriteRule ^mis-estudiantes/?$ frontend/panel.html [L,NC]
  RewriteRule ^nueva-sesion/?$ frontend/panel.html [L,NC]
  
  # ============================================
  # MÓDULOS DEL ESTUDIANTE
  # ============================================
  
  RewriteRule ^estudiante/?$ frontend/panel.html [L,NC]
  RewriteRule ^sesion-actual/?$ frontend/panel.html [L,NC]
  RewriteRule ^historial-tutorias/?$ frontend/panel.html [L,NC]
  
  # ============================================
  # MÓDULOS DEL VERIFICADOR
  # ============================================
  
  RewriteRule ^verificador/?$ frontend/panel.html [L,NC]
  RewriteRule ^administradores/?$ frontend/panel.html [L,NC]
  RewriteRule ^historial-estudiante/?$ frontend/panel.html [L,NC]
  RewriteRule ^seguimiento-tutor/?$ frontend/panel.html [L,NC]

  # ============================================
  # RECURSOS ESTÁTICOS
  # ============================================
  
  # Recursos estáticos (CSS, JS, imágenes, componentes)
  RewriteRule ^js/(.*)$ frontend/js/$1 [L,NC]
  RewriteRule ^css/(.*)$ frontend/css/$1 [L,NC]
  RewriteRule ^assets/(.*)$ frontend/assets/$1 [L,NC]
  RewriteRule ^components/(.*)$ frontend/components/$1 [L,NC]
  RewriteRule ^correos/(.*)$ frontend/correos/$1 [L,NC]
  
  # Permitir acceso directo a archivos estáticos existentes
  RewriteCond %{REQUEST_FILENAME} -f
  RewriteRule ^ - [L]
</IfModule>

# ============================================
# Seguridad - Headers HTTP
# ============================================
<IfModule mod_headers.c>
  # Prevenir clickjacking
  Header always set X-Frame-Options "SAMEORIGIN"
  
  # Prevenir MIME-sniffing
  Header always set X-Content-Type-Options "nosniff"
  
  # Habilitar XSS protection
  Header always set X-XSS-Protection "1; mode=block"
  
  # Control de Caché para JS y CSS
  <FilesMatch "\.(js|css)$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
  </FilesMatch>
  
  # Cache para imágenes y fuentes (1 año)
  <FilesMatch "\.(jpg|jpeg|png|gif|svg|ico|webp|woff|woff2|ttf|eot)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
</IfModule>

# ============================================
# CORS - Permitir solicitudes de API
# ============================================
<IfModule mod_headers.c>
  # Permitir CORS para API
  Header always set Access-Control-Allow-Origin "*"
  Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
  Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
  Header always set Access-Control-Max-Age "3600"
</IfModule>

# ============================================
# Protección de archivos sensibles
# ============================================
<FilesMatch "^\.">
  Require all denied
</FilesMatch>

<FilesMatch "(composer\.json|composer\.lock|package\.json|package-lock\.json|\.git.*|\.env)">
  Require all denied
</FilesMatch>

# ============================================
# Seguridad
# ============================================
<FilesMatch "\.(env|md|sql)$">
  Order allow,deny
  Deny from all
</FilesMatch>
